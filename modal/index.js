"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function i(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,a){return t&&i(e.prototype,t),a&&i(e,a),e}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var getStoragePromise=function(e){e=wx.getStorageSync(e);return e||{}},setStoragePromise=function(e,t){wx.setStorageSync(e,t)},Storage=function(){function e(){_classCallCheck(this,e),this.local={},this.Session={},this.localStatus=!1}return _createClass(e,[{key:"setLocal",value:function(e,t){this.local[e]=t;e=getStoragePromise("FZ_EA_STROAGE");this.local=Object.assign({},e,this.local),this.localStatus=!0,setStoragePromise("FZ_EA_STROAGE",this.local)}},{key:"getLocal",value:function(e){var t;return this.localStatus||(t=getStoragePromise("FZ_EA_STROAGE"),this.local=Object.assign(t,this.local),this.localStatus=!0),e?this.local[e]:this.local}},{key:"getUatLocal",value:function(e){return getStoragePromise("FZ_STROAGE")[e]}},{key:"removeLocal",value:function(e){"undefind"!==this.local[e]&&(delete this.local[e],e=this.local,setStoragePromise("FZ_EA_STROAGE",e))}},{key:"likeRemoveLocal",value:function(e){for(var t in this.local)-1<t.indexOf(e)&&t!==e&&this.removeLocal(t)}}]),e}(),Storage$1=new Storage,config=wx.AnalysysAgentModalConfig;function getToday(){var e=new Date;return e.setTime(e.getTime()),e.getFullYear().toString()+(e.getMonth()+1).toString()+e.getDate().toString()}function getTodayFormat(){var e=new Date;e.setTime(e.getTime());var t=10<=(t=e.getMonth()+1)?t:"0"+t,a=10<=(a=e.getDate())?a:"0"+a;return e.getFullYear().toString()+"/"+t.toString()+"/"+a.toString()}function getsdkVersion(){return"2.1.24"}function getUrlDomain(e){return e.split("?")[0]}function nowDate(){return+new Date+(Storage$1.getUatLocal("ANSSERVERTIME")?Number(Storage$1.getUatLocal("ANSSERVERTIME")):0)}function nowDateFormat(){return+new Date}function toFormat(e,t){e=Number(e);return"hour"===t?60*e*60*1e3:"day"===t?24*e*60*60*1e3:void 0}function getConsole(e,t){config.isTest&&("info"===t?console.log(e):"error"===t&&console.warn(e))}function GetRandomNum(e,t){return e+Math.round(Math.random()*(t-e))}function stringParams(e){function o(e,t){if("object"==(void 0===t?"undefined":_typeof(t)))for(var a in t){var i;"object"!==_typeof(t[a])?(i=e+"["+a+"]="+t[a],n+=encodeURI(i)+"&"):o(e+"["+a+"]",t[a])}return n}var n="",t="";if("object"===(void 0===e?"undefined":_typeof(e)))for(var a in e)"function"!=typeof e[a]&&"object"!==_typeof(e[a])?t+=a+"="+e[a]+"&":"object"===_typeof(e[a])&&(n="",t+=o(a,e[a]));return t.replace(/&$/g,"")}var login=function(i,o,n){var e=Storage$1.getLocal("EAMAC"),s=e&&+new Date-78e6<e?e:+new Date,e=wx.AnalysysAgentModalConfig,t={sdkVersion:getsdkVersion(),appKey:e.appKey,os:{platform:"miniProgram",mac:"EA-"+s,packageName:"com.analysys.eaApp"}};wx.request({url:e.configURL+"push/sdk/login",data:t,method:"POST",success:function(e){e=e.data;if(0===Number(e.code)){getConsole("EA -- 登录成功","info"),Storage$1.setLocal("EAMAC",s),Storage$1.setLocal("EATOKEN"+getToday(),e.token);var t,a=e.rule&&e.rule.dayDialogMaxCount,a=0===a?-99999:a-(Storage$1.getLocal(i+"DAYPOP"+getToday())||0);for(t in Storage$1.setLocal(e.token+i+getToday(),a),Storage$1.getLocal())if(-1<t.indexOf("updateTime")){Storage$1.setLocal("EAUSER",i);break}a=!1;(a=!Storage$1.getLocal("updateTime"+i)||(Storage$1.getLocal("updateTime"+i).toString(),!(Storage$1.getLocal("updateTime"+i).toString()===(e.rule&&e.rule.activityUpdateTime).toString())))&&(Storage$1.likeRemoveLocal("ISGETMODALDATA"+i),Storage$1.setLocal("updateTime"+i,e.rule&&e.rule.activityUpdateTime)),o&&o(e,a)}else n&&n(),getConsole("EA -- 登录失败","error")},fail:function(){n&&n()}})},judeExpression=function(e,t){var a,i,o=!1,n=t.function,s=null,r=t.dataType;for(a in e)a===t.field&&(s=e[a]);if("EQ"===n)o=!(-1===t.value.indexOf(s));else if("NOT_EQ"===n)o=!(-1!==t.value.indexOf(s));else if("CONTAIN"===n)for(var l=0,c=0;c<t.value.length;c++)s&&-1!==s.indexOf(t.value[c])&&(o=!0);else if("NOT_CONTAIN"===n)for(l=0,c=0;c<t.value.length;c++)-1===s.indexOf(t.value[c])&&l++,l===t.value.length&&(o=!0);else if("NOT_NULL"===n)switch(r){case"string":o=!!s;break;case"array":case"array<string>":o=!!s.length;break;default:o=!(null===s)}else if("NULL"===n)switch(r){case"string":o=!s;break;case"array":o=!s.length;break;case"array<string>":o=!!s.length;break;default:o=!(null!==s)}else if("LT"===n)for(c=0;c<t.value.length;c++)s<Number(t.value[c])&&(o=!0);else if("LTE"===n)for(c=0;c<t.value.length;c++)s<=Number(t.value[c])&&(o=!0);else if("GT"===n)for(c=0;c<t.value.length;c++)s>Number(t.value[c])&&(o=!0);else if("GTE"===n)for(c=0;c<t.value.length;c++)s>=Number(t.value[c])&&(o=!0);else"TRUE"===n?o=!(!0!==s):"FALSE"===n?o=!(!1!==s):"RELATIVE_TIME_RANGE_CUURENT"!==n&&"ABSOLUTE_TIME"!==n||2===t.value.length&&null!==s&&(r=t.value[0].replace(/-/g,"/"),n=t.value[1].replace(/-/g,"/"),i=s.replace(/-/g,"/"),new Date(r).getTime()<=new Date(i).getTime()<=new Date(n).getTime()&&(o=!0));return o},Event=function(){function e(){_classCallCheck(this,e),this._listeners={},this.pageKey=null}return _createClass(e,[{key:"_setListeners",value:function(e,t){var a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;this._listeners[e]||(this._listeners[e]=[]),this._listeners[e]&&"function"==typeof t&&this._listeners[e].push({fn:t,isOnce:a})}},{key:"on",value:function(e,t){this._setListeners(e,t)}},{key:"once",value:function(e,t){this._setListeners(e,t,1)}},{key:"emit",value:function(e){for(var t=arguments.length,a=Array(1<t?t-1:0),i=1;i<t;i++)a[i-1]=arguments[i];var o=this._listeners[e];return!!o&&(o.forEach(function(e,t){"function"==typeof e.fn&&e.fn.apply(e,a),e.isOnce&&o.splice(t,1)}),!0)}},{key:"off",value:function(e,t){if(!arguments.length)return this._listeners={};var a=this._listeners[e];if("function"==typeof t){for(var i=0,o=a.length;i<o;i++)if(a[i].fn===t){this._listeners[e].splice(i,1);break}}else delete this._listeners[e]}},{key:"setPageKey",value:function(e){this.pageKey=e}}]),e}(),Event$1=new Event,config$1=wx.AnalysysAgentModalConfig,IntervalTime=3e4,AppSocket=function(){function a(e){if(_classCallCheck(this,a),this.heartTimer=null,this.receiveMessageTimer=null,this.socket=null,!config$1.configURL)return null;var t=config$1.configURL.split(":");if(t.length<2)return null;t[0];t="wss:"+t[1]+"ws?"+stringParams(e);return"undefined"!==wx.connectSocket&&e&&(this.socket=wx.connectSocket({url:t,data:{},fail:function(){},success:function(){}}),this.init()),this.socket}return _createClass(a,[{key:"sendHeart",value:function(){var e=this;this.timerTimer=setInterval(function(){e.send("ping"),e.receiveMessageTimer||(e.receiveMessageTimer=setTimeout(function(){e.socket.close(),e.wsClose()},IntervalTime))},IntervalTime)}},{key:"send",value:function(e){this.socket.send({data:e})}},{key:"wsClose",value:function(){clearInterval(this.timerTimer),clearTimeout(this.receiveMessageTimer),this.heartTimer=null,this.receiveMessageTimer=null}},{key:"init",value:function(){var t=this,e=this.socket;e.onOpen(function(){t.sendHeart()}),e.onMessage(function(e){clearTimeout(t.receiveMessageTimer),t.receiveMessageTimer=null,e.data&&0<=e.data.indexOf("msgType")&&(e=JSON.parse(e.data),wx.AnalysysModalOnMessage(e))}),e.onError(function(){}),e.onClose(function(){t.wsClose(),setTimeout(function(){wx.AnalysysModalAppSocket()},1e4)})}}]),a}(),config$2=wx.AnalysysAgentModalConfig,AnsModal=function(){function e(){_classCallCheck(this,e),getConsole("EA -- ansModal 引入成功，请继续集成<ans-modal/>在您需要的页面中.","info"),this.userId=null,this.token=null,this.updateTime=null,this.countDown=0,this.failTimes=0,this.inappFailTimes=0,this.isFetchData=!1,this.isFetchSubscribeData=!1,this.isDealModalData=!1,this.queueData=[],this.queueSubscribeData=[],this.interval=null,this.socket=null,this.creatingSocket=!1}return _createClass(e,[{key:"init",value:function(e){var a=this;if(e&&0!==e.length){var t=Storage$1.getLocal("XCONTEXT")||{};if("{}"===JSON.stringify(t)){var i,u=e[0].xcontext,g=["$lib","$lib_version","$os","$os_version","$platform","$is_login","$brand","$model","$debug"];for(i in u)-1!==g.indexOf(i)&&(t[i]=u[i]);Storage$1.setLocal("XCONTEXT",t)}for(var o=!1,n=0;n<e.length;n++)"$startup"===e[n].xwhat&&(o=!0);if(0<this.inappFailTimes&&this.failTimes>this.inappFailTimes&&(this.failTimes=this.inappFailTimes),o&&(this.failTimes=0,this.countDown=0,this.getInfo()),!(3<this.failTimes||0<this.countDown)){for(var s=0;s<e.length;s++){if("$profile_set"===e[s].xwhat){this.postUserInfo(e[s]);break}var h=Storage$1.getLocal("UBAAPPKEY");h&&h===e[s].appid||Storage$1.setLocal("UBAAPPKEY",e[s].appid)}if(this.isFetchData)for(var r=0;r<e.length;r++)this.queueData.push(e[r]),this.queueSubscribeData.push(e[r]);else{var l=JSON.parse(JSON.stringify(e)),d=Storage$1.getLocal("EATOKEN"+getToday()),c=l&&l[0]&&l[0].xwho;c&&(config$2.openSocket&&this.setWebSocket(c),o||!d||c!==this.userId?(this.isFetchData=!0,login(c,function(e,t){a.failTimes=0,a.userId=c,a.token=e.token,t?(a.fetchAnsModal(l),a.fetchSubscribeData(l)):(a.isFetchData=!1,a.getStorageModalData(l),a.getSubscribeData(l))},function(){a.isFetchData=!1,a.dealServerError()})):(this.userId=c,this.token=d,this.getStorageModalData(l),this.getSubscribeData(l)))}}}}},{key:"createAppSocket",value:function(e){this.creatingSocket=!0,this.socket=null,e=e||this.userId,this.socket=new AppSocket({uid:e,appKey:config$2.appKey,platform:"miniProgram"}),this.creatingSocket=!1}},{key:"setWebSocket",value:function(e){this.socket||this.creatingSocket?null!==this.userId&&this.userId!==e&&this.socket&&this.socket.close():this.createAppSocket(e)}},{key:"onSocketMessage",value:function(e){e=e.msgType;"POP_UP_MSG"===e?this.fetchAnsModal([]):"SUBSCRIBE_MSG"===e&&this.fetchSubscribeData([])}},{key:"dealServerError",value:function(){var e,t=this;this.failTimes++,4<=this.failTimes||(this.countDown=GetRandomNum(1,60*this.failTimes),e=function(){t.countDown<=0?clearInterval(t.interval):t.countDown--},this.interval=setInterval(function(){e()},1e3),e())}},{key:"getStorageModalData",value:function(e){this.updateTime=Storage$1.getLocal("updateTime"+this.userId);var t;Storage$1.getLocal("ISGETMODALDATA"+this.userId+this.updateTime)?(getConsole("EA -- 成功获取弹窗配置","info"),(t=Storage$1.getLocal("POPMODALDATA"+this.userId))&&t.length!==[]&&this.judeEvents(e,t)):(this.isFetchData=!0,this.fetchAnsModal(e))}},{key:"fetchAnsModal",value:function(n){var e,s;3<this.failTimes||0<this.countDown||(e={token:this.token,os:{platform:"miniProgram"},userId:this.userId,newUser:Storage$1.getLocal("EAUSER")?1:0},(s=this).updateTime=Storage$1.getLocal("updateTime"+this.userId),wx.request({url:config$2.configURL+"push/sdk/in_app",data:e,method:"POST",success:function(e){e=e.data;if(0!==Number(e.code))return getConsole("EA -- 拉取弹窗信息失败","error"),s.isFetchData=!1,s.dealServerError(),void s.inappFailTimes++;s.failTimes=0,getConsole("EA -- 成功拉取弹窗信息","info");var t=e.data,a=t.length;if(0<a){for(var i=[],o=0;o<a;o++)i.push({$dialog_type:0,activityId:t[o].id});s.upLoadEvent("$pullDialog",i,!0)}s.isFetchData=!1,Storage$1.setLocal("ISGETMODALDATA"+s.userId+s.updateTime,!0),Storage$1.setLocal("POPMODALDATA"+s.userId,t),a&&(e=[].concat(_toConsumableArray(n)),0<s.queueData.length&&(e=[].concat(_toConsumableArray(s.queueData),_toConsumableArray(e))),s.judeEvents(e,t),s.queueData=[])},fail:function(){s.isFetchData=!1,s.dealServerError(),s.inappFailTimes++}}))}},{key:"judeEvents",value:function(v,s){var r=this,e=Storage$1.getLocal(this.token+this.userId+getToday());if(!(-99999!==e&&e<=0)){this.isDealModalData=!0;for(var l=0;l<s.length;l++){var c,u,S,m,y,g,h,d,f,p;(function(){if(c=s[l],u=c.doNotDisturbTime,S=getTodayFormat(),m=!1,u&&u.length)for(var e=0;e<u.length;e++)nowDate()>=+new Date(S+" "+u[e].startTime)&&nowDate()<=+new Date(S+" "+u[e].endTime)&&(m=!0);if(m)return;if(c.dialogRule&&0<c.dialogRule.length){y=Storage$1.getLocal("EAPOPEVENTTYPE"+c.id+r.userId),g=null;for(var t=0;t<c.dialogRule.length;t++)c.dialogRule[t].eventType===y&&(g=c.dialogRule[t]);if(g){if(1===g.type)return;if(2===g.type){var a=Storage$1.getLocal(c.id+"POPUPTIMES")||0;if(g.count-a<=0)return}var a=toFormat(g.intervalValue,g.intervalType),i=Storage$1.getLocal("EAPOPNOWFORMAT"+c.id)||0,o=nowDateFormat();if(i&&o<i+a)return}}var o=getCurrentPages(),n=o[o.length-1].route;if(c.preEvents)for(h=0;h<v.length;h++)d=v[h],f=Storage$1.getLocal("PREEVENTINDEXS"+c.id)||0,p=Storage$1.getLocal("USERIPINFO"),d.xcontext&&p&&(d.xcontext.$city=p.$city,d.xcontext.$country=p.$country,d.xcontext.$province=p.$province),c.preEvents.length>f&&c.preEvents[f].xwhat===d.xwhat&&r.judeTriggerProps(d,c.preEvents[f],function(){Storage$1.setLocal("PREEVENTINDEXS"+c.id,f+1),f+1===c.preEvents.length&&(Event$1.emit("setVisible"+n,c),Storage$1.setLocal("PREEVENTINDEXS"+c.id,0),r.isDealModalData=!1)});else"WORKFLOW"===c.activityType&&(Event$1.emit("setVisible"+n,c),r.isDealModalData=!1)})()}Storage$1.setLocal("POPMODALDATA"+this.userId,s)}}},{key:"getSubscribeData",value:function(e){var t;Storage$1.getLocal("ISSUBSCRIBEDATA"+this.userId+this.updateTime)?(getConsole("EA -- 成功获取订阅配置","info"),(t=Storage$1.getLocal("POPSUBSCRIBEDATA"+this.userId))&&t.length&&this.upLoadTriggerEvent(e,t)):(this.isFetchSubscribeData=!0,this.fetchSubscribeData(e))}},{key:"fetchSubscribeData",value:function(a){var e,i;3<this.failTimes||0<this.countDown||(e={token:this.token,os:{platform:"miniProgram",brand:""},sdkVersion:this.sdkVersion,userId:this.userId,newUser:Storage$1.getLocal("EAUSER")?1:0},Storage$1.setLocal("EAUSER",(i=this).userId),wx.request({url:config$2.configURL+"push/sdk/event/subscribe",data:e,method:"POST",success:function(e){e=e.data;if(0!==Number(e.code))return getConsole("EA -- 拉取订阅信息失败","error"),i.isFetchSubscribeData=!1,i.dealServerError(),void i.inappFailTimes++;i.failTimes=0,getConsole("EA -- 成功订阅弹窗信息","info");var e=e.data,t=e.length;i.isFetchSubscribeData=!1,Storage$1.likeRemoveLocal("ISSUBSCRIBEDATA"+i.userId),Storage$1.setLocal("ISSUBSCRIBEDATA"+i.userId+i.updateTime,!0),Storage$1.setLocal("POPSUBSCRIBEDATA"+i.userId,e),0<t&&(t=[].concat(_toConsumableArray(a)),0<i.queueSubscribeData.length&&(t=[].concat(_toConsumableArray(i.queueSubscribeData),_toConsumableArray(t)),i.queueSubscribeData=[]),i.upLoadTriggerEvent(t,e))},fail:function(){i.isFetchData=!1}}))}},{key:"getInfo",value:function(){var e={token:Storage$1.getLocal("EATOKEN"+getToday()),sdkVersion:getsdkVersion(),xwho:this.userId,os:{platform:"miniProgram"}};wx.request({url:config$2.configURL+"push/sdk/ipParsing",data:JSON.stringify(e),method:"POST",success:function(e){e=e.data;"0"!==e.code?getConsole("EA -- 用户信息获取失败","warn"):(getConsole("EA -- 用户信息获取成功","info"),Storage$1.setLocal("USERIPINFO",{$city:e.city,$province:e.province,$country:e.country}))},error:function(){getConsole("EA -- 用户信息获取失败","warn")}})}},{key:"upLoadTriggerEvent",value:function(t,e){for(var a,i=this,o=[],n=0;n<e.length;n++){var s=e[n],r=s.endTime.replace(/-/g,"/");if(!(new Date(r).getTime()<nowDate()))for(var l=0;l<t.length;l++)!function(e){var a=t[e];s.event.xwhat===a.xwhat&&i.judeTriggerProps(a,s.event,function(){for(var e=!0,t=0;t<o.length;t++)o[t].xwhat===a.xwhat&&(e=!1);e&&o.push(a)})}(l)}o.length&&(a={token:Storage$1.getLocal("EATOKEN"+getToday()),os:{platform:"miniProgram",brand:""},sdkVersion:getsdkVersion(),userId:this.userId,newUser:Storage$1.getLocal("EAUSER")?1:0,events:o},wx.request({url:config$2.configURL+"push/sdk/event/trigger",data:JSON.stringify(a),method:"POST",success:function(){getConsole("EA -- 上报成功","info")},error:function(){getConsole("EA -- 上报错误","error")}}))}},{key:"upLoadEvent",value:function(e,t){var a=2<arguments.length&&void 0!==arguments[2]&&arguments[2],i=Storage$1.getLocal("XCONTEXT");if(a)for(var o=0;o<t.length;o++)for(var n in i)t[o][n]=i[n],"$lib_version"===n&&(t[o][n]=getsdkVersion());else for(var n in i)t[n]=i[n],"$lib_version"===n&&(t[n]=getsdkVersion());var s={token:Storage$1.getLocal("EATOKEN"+getToday()),os:{platform:"miniProgram"},sdkVersion:getsdkVersion(),userId:this.userId,events:[{xwho:this.userId,xwhen:nowDate(),xwhat:e,xcontext:t}]};if(a){s.events=[];for(var r=0;r<t.length;r++)s.events.push({xwho:this.userId,xwhen:nowDate(),xwhat:e,xcontext:t[r]})}wx.request({url:config$2.configURL+"push/sdk/in_app/callback",data:JSON.stringify(s),method:"POST",success:function(){getConsole("EA -- 上报成功","info")},error:function(){getConsole("EA -- 上报错误","error")}})}},{key:"judeTriggerProps",value:function(e,t,a){var i=!1,o=t.relation,n=e.xcontext;if(n.xwho=e.xwho,n.xwhat=e.xwhat,n.appid=e.appid,n.xwhen=e.xwhen,t.rule&&t.rule.length){for(var s=0,u=t.rule.length,r=0;r<u;r++)if(judeExpression(n,t.rule[r])&&s++,"AND"===o&&s===u&&(i=!0),"OR"===o&&0<s){i=!0;break}}else i=!0;if("{}"!==JSON.stringify(t.xcontext)&&null!==t.xcontext||!i){var g,l,h=0;for(g in t.xcontext)h++;for(l in t.xcontext){var c,d=0,f="$url_domain"===l?getUrlDomain(t.xcontext[l]):t.xcontext[l];for(c in e.xcontext){var p=!("$url"!==c||"$url_domain"!==l),v=p?getUrlDomain(e.xcontext[c]):e.xcontext[c];l!==c&&!p||f!==v||++d===h&&i&&a&&a()}}}else a&&a()}},{key:"setUserId",value:function(e){this.userId=e}},{key:"dealModalPopNum",value:function(e,t){var a=Storage$1.getLocal(this.userId+"DAYPOP"+getToday())||0,a=(Storage$1.likeRemoveLocal(this.userId+"DAYPOP"),Storage$1.setLocal(this.userId+"DAYPOP"+getToday(),a+1),Storage$1.getLocal(this.token+this.userId+getToday())),a=(-99999!==a&&(Storage$1.likeRemoveLocal(this.token+this.userId),Storage$1.setLocal(this.token+this.userId+getToday(),a-1)),Storage$1.getLocal(e.id+"POPUPTIMES")||0);Storage$1.setLocal(e.id+"POPUPTIMES",a+1),this.dealModalType(e,t)}},{key:"dealModalType",value:function(e,t){if(e.dialogRule){for(var a,i=null,o=0;o<e.dialogRule.length;o++)if(e.dialogRule[o].eventType===t){i=e.dialogRule[o];break}i&&(Storage$1.setLocal("EAPOPEVENTTYPE"+e.id+this.userId,t),a=nowDateFormat(),Storage$1.setLocal("EAPOPNOWFORMAT"+e.id,a))}}},{key:"postUserInfo",value:function(t){var a,i,o;t.xcontext.openid&&t.xcontext.wx_appid?(a=this,i=function(){var e={token:a.token,appId:t.xcontext.wx_appid,openId:t.xcontext.openid,unionId:t.xcontext.unionid,xwho:t.xwho,serviceType:3,ubaAppKey:Storage$1.getLocal("UBAAPPKEY")};wx.request({url:config$2.configURL+"push/wechat/user/profile",data:JSON.stringify(e),method:"POST",success:function(){getConsole("EA -- 用户信息上报成功","info")},error:function(){getConsole("EA -- 用户信息上报错误","error")}})},o=0,function e(){a.token?i():(o++,setTimeout(function(){o<60?e():getConsole("EA -- 用户数据上报接口异常","error")},100))}()):getConsole("EA -- 用户数据上报异常")}}],[{key:"getInstance",value:function(){return this.ansModal||(this.ansModal=new e)}}]),e}(),ansModal=AnsModal.getInstance();wx.AnalysysModal=function(e){wx.AnalysysAgentModalConfig&&wx.AnalysysAgentModalConfig.appKey&&wx.AnalysysAgentModalConfig.configURL?ansModal.init(e,Event$1.pageKey):console.warn("EA -- 请设置弹窗配置appKey和configURL")},wx.AnalysysModalAppSocket=function(){ansModal.createAppSocket()},wx.AnalysysModalOnMessage=function(e){ansModal.onSocketMessage(e)},Component({data:{visible:!1,popupData:{},cacheData:[],imgHeight:0,imgWidth:0,currentPage:null,navigateParams:{target:"self",appId:"",path:""}},attached:function(){var i=this,e=getCurrentPages();this.currentPage=e[e.length-1].route,Event$1.on("setVisible"+this.currentPage,function(e){if(i.data.visible){for(var t=!1,a=0;a<i.data.cacheData.length;a++)if(i.data.cacheData[a].id===e.id){t=!0;break}(t=e.id===i.data.popupData.id?!0:t)||i.data.cacheData.unshift(e)}else i.dealData(e)})},detached:function(){this.hideModal()},methods:{dealData:function(e){this.dealPicInfo(e.picInfo),this.setData({popupData:e,visible:!0}),ansModal.upLoadEvent("$impDialog",{activityId:e.id,$dialog_type:1}),ansModal.dealModalPopNum(e,"exposure")},dealPicInfo:function(e){var t,a,i;e?(a=t=void 0,.8*(i=wx.getSystemInfoSync()).windowWidth<e.width?(t=(.8*i.windowWidth/e.width*e.height).toFixed(3),a=.8*i.windowWidth):(a=e.width,t=e.height),this.setData({imgHeight:t,imgWidth:a})):(i=wx.getSystemInfoSync().SDKVersion.replace(/\./g,""),Number(i)<210&&this.setData({imgHeight:400,imgWidth:400}))},hideModal:function(){this.setData({visible:!1});var e=Storage$1.getLocal(ansModal.token+ansModal.userId+getToday());-99999!==e&&e<=0||0<(e=this.data.cacheData.length)&&(this.dealData(this.data.cacheData[e-1]),this.data.cacheData.pop())},handleClick:function(e,t,a){var i=this.data.popupData;i.id&&(ansModal.upLoadEvent(t,{activityId:i.id.toString(),$dialog_type:a}),ansModal.dealModalType(i,{$closeDialog:"close",$clickDialog:"click"}[t])),this.hideModal()},handleClose:function(){this.handleClick("","$closeDialog",3)},handleLeftClick:function(){this.handleClick(this.data.popupData&&this.data.popupData.buttonLeft.clickEvent,"$clickDialog",4)},handleRightClick:function(){this.handleClick(this.data.popupData&&this.data.popupData.buttonRight.clickEvent,"$clickDialog",5)},handleMiddleClick:function(){this.handleClick(this.data.popupData&&this.data.popupData.buttonMiddle.clickEvent,"$clickDialog",6)},onImageClick:function(e){0===e.currentTarget.dataset.type?(e=this.data.popupData&&this.data.popupData.clickEvent,this.handleClick(e,"$clickDialog",2)):ansModal.upLoadEvent("$clickDialog",{activityId:this.data.popupData.id.toString(),$dialog_type:2})},onImageError:function(){this.hideModal()},onImageLoad:function(e){!this.data.popupData&&this.data.popupData.picInfo&&this.dealPicInfo(e.detail)},jumpToSelfPage:function(e){e.clickEvent&&wx.navigateTo({url:e.clickEvent,fail:function(){wx.switchTab({url:e.clickEvent})}})},jumpToOtherMiniPage:function(e){e.clickAppId&&e.clickEvent&&wx.navigateToMiniProgram({appId:e.clickAppId,path:e.clickEvent,success:function(e){console.log(e)}})},jumpToPublicArticle:function(e){e.clickEvent?wx.AnalysysAgentModalConfig.publicWebviewUrl?wx.navigateTo({url:wx.AnalysysAgentModalConfig.publicWebviewUrl+"?url="+e.clickEvent,fail:function(){wx.switchTab({url:wx.AnalysysAgentModalConfig.publicWebviewUrl+"?url="+e.clickEvent})}}):console.warn("请配置跳转公众号的容器页面地址publicWebviewUrl(eg. /pages/webView/webView"):console.log("跳转地址为空，如需跳转请配置地址")},handleCoverClick:function(e){var e=e.target.dataset.elm,t=this.data.popupData;if(e){var a=t[e]||{clickAppId:t.clickAppId,clickEvent:t.clickEvent,clickType:t.clickType};switch(1===a.clickType&&a.clickEvent&&"/"!==a.clickEvent.charAt(0)&&(a.clickEvent="/"+a.clickEvent),a.clickType){case 1:this.jumpToSelfPage(a);break;case 2:this.jumpToOtherMiniPage(a);break;case 3:this.jumpToPublicArticle(a);break;default:console.warn("please check type=",a.clickType)}}}},bindSuccess:function(e){console.log(e)},bindFail:function(e){console.log(e)}});
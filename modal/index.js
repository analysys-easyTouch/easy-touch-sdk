let getStoragePromise=function(e){let t=wx.getStorageSync(e);return t||{}},setStoragePromise=function(e,t){wx.setStorageSync(e,t)};class Storage{constructor(){this.local={},this.Session={},this.localStatus=!1}setLocal(e,t){this.local[e]=t;let a=getStoragePromise("FZ_EA_STROAGE");this.local=Object.assign({},a,this.local),this.localStatus=!0,setStoragePromise("FZ_EA_STROAGE",this.local)}getLocal(e){if(!this.localStatus){let e=getStoragePromise("FZ_EA_STROAGE");this.local=Object.assign(e,this.local),this.localStatus=!0}return this.local[e]}getUatLocal(e){return getStoragePromise("FZ_STROAGE")[e]}removeLocal(e){if("undefind"!==this.local[e]){delete this.local[e];let t=this.local;setStoragePromise("FZ_EA_STROAGE",t).then(()=>{},()=>{}).catch(e=>{})}}}var Storage$1=new Storage;function getToday(){var e=new Date;return e.setTime(e.getTime()),e.getFullYear().toString()+(e.getMonth()+1).toString()+e.getDate().toString()}function getsdkVersion(){return"1.1.7"}function getUrlDomain(e){return e.split("?")[0]}function nowDate(){return+new Date+(Storage$1.getUatLocal("ANSSERVERTIME")?Number(Storage$1.getUatLocal("ANSSERVERTIME")):0)}let login=(e,t)=>{let a=wx.AnalysysAgentModalConfig,i={sdkVersion:getsdkVersion(),appKey:a.appKey,os:{platform:"miniProgram",mac:"qaew",packageName:"com.analysys.eaApp"}};wx.request({url:a.configURL+"push/sdk/login",data:i,method:"POST",success({data:a}){if(0===Number(a.code)){console.log("EA -- 登录成功"),Storage$1.setLocal("EATOKEN"+getToday(),a.token);let s=a.rule&&a.rule.dayDialogMaxCount,l=0===s?-99999:s-(Storage$1.getLocal(e+"DAYPOP"+getToday())||0);Storage$1.setLocal(a.token+e+getToday(),l);var i=Storage$1.getLocal();for(var o in i)if(o.indexOf("updateTime")>-1){Storage$1.setLocal("EAUSER",e);break}let n=!1;n=!(Storage$1.getLocal("updateTime"+e)&&Storage$1.getLocal("updateTime"+e).toString()===(a.rule&&a.rule.activityUpdateTime).toString()),n&&Storage$1.setLocal("updateTime"+e,a.rule&&a.rule.activityUpdateTime),t&&t(a,n)}else console.warn("EA -- 登录失败")}})};var judeExpression=(e,t)=>{var a=!1,i=t.function,o=null,s=t.dataType;for(var l in e)l===t.field&&(o=e[l]);if("EQ"===i)a=!(-1===t.value.indexOf(o));else if("NOT_EQ"===i)a=!(-1!==t.value.indexOf(o));else if("CONTAIN"===i)for(var n=0,r=0;r<t.value.length;r++)-1!==o.indexOf(t.value[r])&&n++,n===t.value.length&&(a=!0);else if("NOT_CONTAIN"===i)for(n=0,r=0;r<t.value.length;r++)-1===o.indexOf(t.value[r])&&n++,n===t.value.length&&(a=!0);else if("NOT_NULL"===i)switch(s){case"string":a=!!o;break;case"array":case"array<string>":a=!!o.length;break;default:a=!(null===o)}else if("NULL"===i)switch(s){case"string":a=!o;break;case"array":a=!o.length;break;case"array<string>":a=!!o.length;break;default:a=!(null!==o)}else if("LT"===i)for(r=0;r<t.value.length;r++)o<Number(t.value[r])&&(a=!0);else if("LTE"===i)for(r=0;r<t.value.length;r++)o<=Number(t.value[r])&&(a=!0);else if("GT"===i)for(r=0;r<t.value.length;r++)o>Number(t.value[r])&&(a=!0);else if("GTE"===i)for(r=0;r<t.value.length;r++)o>=Number(t.value[r])&&(a=!0);else"TRUE"===i?a=!(!0!==o):"FALSE"===i?a=!(!1!==o):"RELATIVE_TIME_RANGE_CUURENT"!==i&&"ABSOLUTE_TIME"!==i||2===t.value.length&&null!==o&&new Date(t.value[0]).getTime()<=new Date(o).getTime()<=new Date(t.value[1]).getTime()&&(a=!0);return a};class Event{constructor(){this._listeners={},this.pageKey=null}_setListeners(e,t,a=0){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e]&&"function"==typeof t&&this._listeners[e].push({fn:t,isOnce:a})}on(e,t){this._setListeners(e,t)}once(e,t){this._setListeners(e,t,1)}emit(e,...t){let a=this._listeners[e];return!!a&&(a.forEach((e,i)=>{"function"==typeof e.fn&&e.fn(...t),e.isOnce&&a.splice(i,1)}),!0)}off(e,t){if(!arguments.length)return this._listeners={};let a=this._listeners[e];if("function"==typeof t){for(let i=0,o=a.length;i<o;i++)if(a[i].fn===t){this._listeners[e].splice(i,1);break}}else delete this._listeners[e]}setPageKey(e){this.pageKey=e}}var Event$1=new Event;let config=wx.AnalysysAgentModalConfig;class AnsModal{constructor(){console.log("EA -- ansModal 引入成功，请继续集成<ans-modal/>在您需要的页面中."),this.userId=null,this.token=null,this.updateTime=null,this.isFetchData=!1,this.isDealModalData=!1,this.queueData=[]}static getInstance(){return this.ansModal||(this.ansModal=new AnsModal)}init(e){if(!e)return;for(let t=0;t<e.length;t++)if("$profile_set"===e[t].xwhat){this.postUserInfo(e[t]);break}if(this.isFetchData){for(let t=0;t<e.length;t++)this.queueData.push(e[t]);return}let t=Storage$1.getLocal("EATOKEN"+getToday());for(let a=0;a<e.length&&!this.isFetchData;a++){if("$startup"!==e[a].xwhat&&this.userId===e[a].xwho&&t){this.userId=e[a].xwho,this.token=t,this.getStorageModalData(e);break}login(e[a].xwho,(t,i)=>{this.userId=e[a].xwho,this.token=t.token,i?this.fetchAnsModal(e):this.getStorageModalData(e)});break}}getStorageModalData(e){this.updateTime=Storage$1.getLocal("updateTime"+this.userId);let t=Storage$1.getLocal("ISGETMODALDATA"+this.userId+this.updateTime),a=[];console.log("EA -- 成功获取弹窗配置"),t?(a=Storage$1.getLocal("POPMODALDATA"+this.userId),a&&a.length!==[]&&this.judeEvents(e,a)):this.fetchAnsModal(e)}fetchAnsModal(e){this.isFetchData=!0;let t={token:this.token,os:{platform:"miniProgram"},userId:this.userId,newUser:Storage$1.getLocal("EAUSER")?1:0},a=this;this.updateTime=Storage$1.getLocal("updateTime"+this.userId),Storage$1.setLocal("EAUSER",this.userId),wx.request({url:config.configURL+"push/sdk/in_app",data:t,method:"POST",success({data:t}){if(0!==Number(t.code))return void console.warn("EA -- 拉取弹窗信息失败");console.log("EA -- 成功拉取弹窗信息");let i=t.data,o=i.length;if(o>0){let e=[];for(let t=0;t<o;t++)e.push({$dialog_type:0,activityId:i[t].id});a.upLoadEvent("$pullDialog",e,!0)}a.isFetchData=!1,Storage$1.setLocal("ISGETMODALDATA"+a.userId+a.updateTime,!0),Storage$1.setLocal("POPMODALDATA"+a.userId,i),a.judeEvents(e,i),a.queueData.length>0&&(a.judeEvents(a.queueData,i),a.queueData=[])}})}judeEvents(e,t){let a=Storage$1.getLocal(this.token+this.userId+getToday());if(!(-99999!==a&&a<=0)){this.isDealModalData=!0;for(var i=0;i<t.length;i++){var o=t[i];if(0===(1===o.closeDialogType?Storage$1.getLocal("EAPOP"+o.id+getToday()):Storage$1.getLocal("EAPOP"+o.id)))continue;if(0!==o.count){let e=Storage$1.getLocal(o.id+"POPUPTIMES")||0;if(o.count-e<=0)continue}let a=getCurrentPages(),d=a[a.length-1].route;for(var s=0;s<e.length;s++){var l=e[s],n=Storage$1.getLocal("PREEVENTINDEX"+o.id)||0;if(!o.event||o.preEvent||o.preEvents||o.event.xwhat===l.xwhat&&this.judeTriggerProps(l,o.event,()=>{Event$1.emit("setVisible"+d,o),this.isDealModalData=!1}),o.event&&o.preEvent){var r=null;for(var g in l.xcontext)"$session_id"===g&&(r=l.xcontext[g]);var h=Storage$1.getLocal("isTriggerPreEvent"+o.id+r);h&&o.event.xwhat===l.xwhat?this.judeTriggerProps(l,o.event,()=>{Event$1.emit("setVisible"+d,o),this.isDealModalData=!1}):o.preEvent.xwhat!==l.xwhat||h||this.judeTriggerProps(l,o.preEvent,()=>{Storage$1.setLocal("isTriggerPreEvent"+o.id+r,!0),this.isDealModalData=!1})}o.preEvents&&o.preEvents.length>0&&o.event&&(o.event.xwhat===l.xwhat&&n===o.preEvents.length?this.judeTriggerProps(l,o.event,()=>{Event$1.emit("setVisible"+d,o),this.isDealModalData=!1}):o.preEvents.length>n&&o.preEvents[n].xwhat===l.xwhat&&this.judeTriggerProps(l,o.preEvents[n],()=>{Storage$1.setLocal("PREEVENTINDEX"+o.id,n+1)})),o.preEvents&&!o.event&&o.preEvents.length>n&&o.preEvents[n].xwhat===l.xwhat&&this.judeTriggerProps(l,o.preEvents[n],()=>{Storage$1.setLocal("PREEVENTINDEX"+o.id,n+1),n+1===o.preEvents.length&&(Event$1.emit("setVisible"+d,o),this.isDealModalData=!1)}),!o.event&&o.preEvent&&o.preEvent.xwhat===l.xwhat&&this.judeTriggerProps(l,o.preEvent,()=>{Event$1.emit("setVisible"+d,o),this.isDealModalData=!1})}}Storage$1.setLocal("POPMODALDATA"+this.userId,t)}}upLoadEvent(e,t,a=!1){var i={token:Storage$1.getLocal("EATOKEN"+getToday()),os:{platform:"miniProgram"},sdkVersion:getsdkVersion(),userId:this.userId,events:[{xwho:this.userId,xwhen:nowDate(),xwhat:e,xcontext:t}]};if(a){i.events=[];for(let a=0;a<t.length;a++)i.events.push({xwho:this.userId,xwhen:nowDate(),xwhat:e,xcontext:t[a]})}wx.request({url:config.configURL+"push/sdk/in_app/callback",data:JSON.stringify(i),method:"POST",success(){console.log("EA -- 上报成功")},error(){console.log("EA -- 上报错误")}})}judeTriggerProps(e,t,a){var i=!1;if(t.rule&&0!==t.rule.length)for(var o=0,s=t.rule.length,l=0;l<s;l++){judeExpression(e.xcontext,t.rule[l])&&o++,o===s&&(i=!0)}else i=!0;if("{}"!==JSON.stringify(t.xcontext)&&null!==t.xcontext||!i){var n=0;for(var r in t.xcontext)n++;for(var g in t.xcontext){l=0;var h="$url_domain"===g?getUrlDomain(t.xcontext[g]):t.xcontext[g];for(var d in e.xcontext){var c=!("$url"!==d||"$url_domain"!==g),u=c?getUrlDomain(e.xcontext[d]):e.xcontext[d];g!==d&&!c||h!==u||++l===n&&i&&a&&a()}}}else a&&a()}setUserId(e){this.userId=e}dealModalPopNum(e){let t=Storage$1.getLocal(e.id+"POPUPTIMES")||0;Storage$1.setLocal(e.id+"POPUPTIMES",t+1);let a=Storage$1.getLocal(this.userId+"DAYPOP"+getToday())||0;Storage$1.setLocal(this.userId+"DAYPOP"+getToday(),a+1);let i=Storage$1.getLocal(this.token+this.userId+getToday());-99999!==i&&Storage$1.setLocal(this.token+this.userId+getToday(),i-1);var o=e.closeDialogType;1===Number(o)?Storage$1.setLocal("EAPOP"+e.id+getToday(),0):Storage$1.setLocal("EAPOP"+e.id,0)}postUserInfo(e){if(!e.xcontext.openId||!e.xcontext.unionId)return;let t=this,a=0,i=()=>{t.token?(()=>{let a={token:t.token,appId:e.appid,openId:e.xcontext.openId,unionId:e.xcontext.unionId,xwho:e.xwho};wx.request({url:config.configURL+"push/wechat/user/profile",data:JSON.stringify(a),method:"POST",success(){console.log("EA -- 用户信息上报成功")},error(){console.log("EA -- 用户信息上报错误")}})})():(a++,setTimeout(()=>{a<60?i():console.log("EA -- 用户数据上报接口异常")},100))};i()}}const ansModal=AnsModal.getInstance();wx.AnalysysModal=e=>{wx.AnalysysAgentModalConfig&&wx.AnalysysAgentModalConfig.appKey&&wx.AnalysysAgentModalConfig.configURL?ansModal.init(e,Event$1.pageKey):console.warn("EA -- 请设置弹窗配置appKey和configURL")},Component({data:{visible:!1,popupData:{},cacheData:[],imgHeight:0,imgWidth:0,currentPage:null},attached(){let e=getCurrentPages();this.currentPage=e[e.length-1].route,Event$1.on("setVisible"+this.currentPage,e=>{if(this.data.visible){let t=!1;for(let a=0;a<this.data.cacheData.length;a++)if(this.data.cacheData[a].id===e.id){t=!0;break}e.id===this.data.popupData.id&&(t=!0),t||this.data.cacheData.unshift(e)}else this.dealData(e)})},detached(){this.hideModal()},methods:{dealData(e){this.dealPicInfo(e.picInfo),this.setData({popupData:e,visible:!0}),ansModal.upLoadEvent("$impDialog",{activityId:e.id,$dialog_type:1})},dealPicInfo(e){if(e){let t,a,i=wx.getSystemInfoSync();.8*i.windowWidth<e.width?(t=(.8*i.windowWidth/e.width*e.height).toFixed(3),a=.8*i.windowWidth):(a=e.width,t=e.height),this.setData({imgHeight:t,imgWidth:a})}else{let e=wx.getSystemInfoSync().SDKVersion.replace(/\./g,"");Number(e)<210&&this.setData({imgHeight:400,imgWidth:400})}},hideModal(){this.setData({visible:!1});let e=Storage$1.getLocal(ansModal.token+ansModal.userId+getToday());if(-99999!==e&&e<=0)return;let t=this.data.cacheData.length;t>0&&(this.dealData(this.data.cacheData[t-1]),this.data.cacheData.pop())},handleClick(e,t,a){let i=this.data.popupData;if(!i.id)return void this.hideModal();ansModal.upLoadEvent(t,{activityId:i.id.toString(),$dialog_type:a}),ansModal.dealModalPopNum(i),this.hideModal();let o="";e&&("/"!==e.charAt(0)&&(o="/"+e),wx.navigateTo({url:o}),wx.switchTab({url:o}))},handleClose(){this.handleClick("","$closeDialog",3)},handleLeftClick(){this.handleClick(this.data.popupData&&this.data.popupData.buttonLeft.clickEvent,"$clickDialog",4)},handleRightClick(){this.handleClick(this.data.popupData&&this.data.popupData.buttonRight.clickEvent,"$clickDialog",5)},handleMiddleClick(){this.handleClick(this.data.popupData&&this.data.popupData.buttonMiddle.clickEvent,"$clickDialog",6)},onImageClick(e){if(0===e.currentTarget.dataset.type){let e=this.data.popupData&&this.data.popupData.clickEvent;this.handleClick(e,"$clickDialog",2)}else ansModal.upLoadEvent("$clickDialog",{activityId:this.data.popupData.id.toString(),$dialog_type:2})},onImageError(){this.hideModal()},onImageLoad(e){!this.data.popupData&&this.data.popupData.picInfo&&this.dealPicInfo(e.detail)}}});
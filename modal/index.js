let getStoragePromise=function(e){let t=wx.getStorageSync(e);return t||{}},setStoragePromise=function(e,t){wx.setStorageSync(e,t)};class Storage{constructor(){this.local={},this.Session={},this.localStatus=!1}setLocal(e,t){this.local[e]=t;let a=getStoragePromise("FZ_EA_STROAGE");this.local=Object.assign({},a,this.local),this.localStatus=!0,setStoragePromise("FZ_EA_STROAGE",this.local)}getLocal(e){if(!this.localStatus){let e=getStoragePromise("FZ_EA_STROAGE");this.local=Object.assign(e,this.local),this.localStatus=!0}return this.local[e]}getUatLocal(e){return getStoragePromise("FZ_STROAGE")[e]}removeLocal(e){if("undefind"!==this.local[e]){delete this.local[e];let t=this.local;setStoragePromise("FZ_EA_STROAGE",t).then(()=>{},()=>{}).catch(e=>{})}}}var Storage$1=new Storage;function getToday(){var e=new Date;return e.setTime(e.getTime()),e.getFullYear().toString()+(e.getMonth()+1).toString()+e.getDate().toString()}function getsdkVersion(){return"1.0.0"}function getUrlDomain(e){return e.split("?")[0]}function nowDate(){return+new Date+(Storage$1.getUatLocal("ANSSERVERTIME")?Number(Storage$1.getUatLocal("ANSSERVERTIME")):0)}let login=(e,t)=>{let a=wx.AnalysysAgentModalConfig,i={sdkVersion:getsdkVersion(),appKey:a.appKey,os:{platform:"miniProgram",mac:"qaew",packageName:"com.analysys.eaApp"}};wx.request({url:a.configURL+"push/sdk/login",data:i,method:"POST",success({data:a}){if(0===Number(a.code)){console.log("EA -- 登录成功"),Storage$1.setLocal("EATOKEN"+getToday(),a.token);let i=a.rule&&a.rule.dayDialogMaxCount,s=0===i?-99999:i-(Storage$1.getLocal(e+"DAYPOP"+getToday())||0);Storage$1.setLocal(a.token+e+getToday(),s);let o=!1;o=!(Storage$1.getLocal("updateTime"+e)&&Storage$1.getLocal("updateTime"+e).toString()===(a.rule&&a.rule.activityUpdateTime).toString()),o&&Storage$1.setLocal("updateTime"+e,a.rule&&a.rule.activityUpdateTime),t&&t(a,o)}else console.warn("EA -- 登录失败")}})};var judeExpression=(e,t)=>{var a=!1,i=t.function,s=null,o=t.dataType;for(var l in e)l===t.field&&(s=e[l]);if("EQ"===i)a=!(-1===t.value.indexOf(s));else if("NOT_EQ"===i)a=!(-1!==t.value.indexOf(s));else if("CONTAIN"===i)for(var n=0,r=0;r<t.value.length;r++)-1!==s.indexOf(t.value[r])&&n++,n===t.value.length&&(a=!0);else if("NOT_CONTAIN"===i)for(n=0,r=0;r<t.value.length;r++)-1===s.indexOf(t.value[r])&&n++,n===t.value.length&&(a=!0);else if("NOT_NULL"===i)switch(o){case"string":a=!!s;break;case"array":case"array<string>":a=!!s.length;break;default:a=!(null===s)}else if("NULL"===i)switch(o){case"string":a=!s;break;case"array":a=!s.length;break;case"array<string>":a=!!s.length;break;default:a=!(null!==s)}else if("LT"===i)for(r=0;r<t.value.length;r++)s<Number(t.value[r])&&(a=!0);else if("LTE"===i)for(r=0;r<t.value.length;r++)s<=Number(t.value[r])&&(a=!0);else if("GT"===i)for(r=0;r<t.value.length;r++)s>Number(t.value[r])&&(a=!0);else if("GTE"===i)for(r=0;r<t.value.length;r++)s>=Number(t.value[r])&&(a=!0);else"TRUE"===i?a=!(!0!==s):"FALSE"===i?a=!(!1!==s):"RELATIVE_TIME_RANGE_CUURENT"!==i&&"ABSOLUTE_TIME"!==i||2===t.value.length&&null!==s&&new Date(t.value[0]).getTime()<=new Date(s).getTime()<=new Date(t.value[1]).getTime()&&(a=!0);return a};class Event{constructor(){this._listeners={},this.pageKey=null}_setListeners(e,t,a=0){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e]&&"function"==typeof t&&this._listeners[e].push({fn:t,isOnce:a})}on(e,t){this._setListeners(e,t)}once(e,t){this._setListeners(e,t,1)}emit(e,...t){let a=this._listeners[e];return!!a&&(a.forEach((e,i)=>{"function"==typeof e.fn&&e.fn(...t),e.isOnce&&a.splice(i,1)}),!0)}off(e,t){if(!arguments.length)return this._listeners={};let a=this._listeners[e];if("function"==typeof t){for(let i=0,s=a.length;i<s;i++)if(a[i].fn===t){this._listeners[e].splice(i,1);break}}else delete this._listeners[e]}setPageKey(e){this.pageKey=e}}var Event$1=new Event;let config=wx.AnalysysAgentModalConfig;class AnsModal{constructor(){console.log("EA -- ansModal 引入成功，请继续集成<ans-modal/>在您需要的页面中."),this.userId=null,this.token=null,this.updateTime=null,this.isFetchData=!1,this.isDealModalData=!1,this.queueData=[]}static getInstance(){return this.ansModal||(this.ansModal=new AnsModal)}init(e){if(!e)return;let t=Storage$1.getLocal("EATOKEN"+getToday());for(let a=0;a<e.length;a++)if("$startup"!==e[a].xwhat&&this.userId===e[a].xwho&&t)this.userId=e[a].xwho,this.token=t,this.getStorageModalData(e);else{if(this.userId=e[a].xwho,this.isFetchData)return void this.queueData.push(e[a]);this.isFetchData=!0,login(this.userId,(t,a)=>{this.token=t.token,a?this.fetchAnsModal(e):(this.isFetchData=!1,this.getStorageModalData(e))})}}getStorageModalData(e){this.updateTime=Storage$1.getLocal("updateTime"+this.userId);let t=Storage$1.getLocal("ISGETMODALDATA"+this.userId+this.updateTime),a=[];console.log("EA -- 成功获取弹窗配置"),t?(a=Storage$1.getLocal("POPMODALDATA"+this.userId),a&&a.length!==[]&&this.judeEvents(e,a)):this.fetchAnsModal(e)}fetchAnsModal(e){let t={token:this.token,os:{platform:"miniProgram"},userId:this.userId},a=this;this.updateTime=Storage$1.getLocal("updateTime"+this.userId),wx.request({url:config.configURL+"push/sdk/in_app",data:t,method:"POST",success({data:t}){if(a.isFetchData=!1,0!==Number(t.code))return void console.warn("EA -- 拉取弹窗信息失败");console.log("EA -- 成功拉取弹窗信息");let i=t.data,s=i.length;if(s>0){let e=[];for(let t=0;t<s;t++)e.push(i[t].id);a.upLoadEvent("$pullDialog",{$dialog_type:0,$dialog_id:e.toString()})}Storage$1.setLocal("ISGETMODALDATA"+a.userId+a.updateTime,!0),Storage$1.setLocal("POPMODALDATA"+a.userId,i),a.judeEvents(e,i),a.queueData.length>0&&(a.judeEvents(a.queueData,i),a.queueData=[])}})}judeEvents(e,t){let a=Storage$1.getLocal(this.token+this.userId+getToday());if(!(-99999!==a&&a<=0)){this.isDealModalData=!0;for(var i=0;i<t.length;i++){var s=t[i];if(0===(1===s.closeDialogType?Storage$1.getLocal("EAPOP"+s.id+getToday()):Storage$1.getLocal("EAPOP"+s.id)))continue;if(0!==s.count){let e=Storage$1.getLocal(s.id+"POPUPTIMES")||0;if(s.count-e<=0)continue}let a=getCurrentPages(),d=a[a.length-1].route;for(var o=0;o<e.length;o++){var l=e[o];if(s.preEvent)if(s.event){var n=null;for(var r in l.xcontext)"$session_id"===r&&(n=l.xcontext[r]);var g=Storage$1.getLocal("isTriggerPreEvent"+s.id+n);g&&s.event.xwhat===l.xwhat?this.judeTriggerProps(l,s.event,()=>{Event$1.emit("setVisible"+d,s),this.isDealModalData=!1}):s.preEvent.xwhat!==l.xwhat||g||this.judeTriggerProps(l,s.preEvent,()=>{Storage$1.setLocal("isTriggerPreEvent"+s.id+n,!0),this.isDealModalData=!1})}else s.preEvent.xwhat===l.xwhat&&this.judeTriggerProps(l,s.preEvent,()=>{Event$1.emit("setVisible"+d,s),this.isDealModalData=!1})}}Storage$1.setLocal("POPMODALDATA"+this.userId,t)}}upLoadEvent(e,t){var a={token:Storage$1.getLocal("EATOKEN"+getToday()),os:{platform:"miniProgram"},sdkVersion:getsdkVersion(),userId:this.userId,events:[{xwho:this.userId,xwhen:nowDate(),xwhat:e,xcontext:t}]};wx.request({url:config.configURL+"push/sdk/in_app/callback",data:JSON.stringify(a),method:"POST",success(){console.log("EA -- 上报成功")},error(){console.log("EA -- 上报错误")}})}judeTriggerProps(e,t,a){var i=!1;if(t.rule&&0!==t.rule.length)for(var s=0,o=t.rule.length,l=0;l<o;l++){judeExpression(e.xcontext,t.rule[l])&&s++,s===o&&(i=!0)}else i=!0;if("{}"!==JSON.stringify(t.xcontext)&&null!==t.xcontext||!i){var n=0;for(var r in t.xcontext)n++;for(var g in t.xcontext){l=0;var d="$url_domain"===g?getUrlDomain(t.xcontext[g]):t.xcontext[g];for(var h in e.xcontext){var c=!("$url"!==h||"$url_domain"!==g),u=c?getUrlDomain(e.xcontext[h]):e.xcontext[h];g!==h&&!c||d!==u||++l===n&&i&&a&&a()}}}else a&&a()}setUserId(e){this.userId=e}dealModalPopNum(e){let t=Storage$1.getLocal(e.id+"POPUPTIMES")||0;Storage$1.setLocal(e.id+"POPUPTIMES",t+1);let a=Storage$1.getLocal(this.userId+"DAYPOP"+getToday())||0;Storage$1.setLocal(this.userId+"DAYPOP"+getToday(),a+1);let i=Storage$1.getLocal(this.token+this.userId+getToday());-99999!==i&&Storage$1.setLocal(this.token+this.userId+getToday(),i-1);var s=e.closeDialogType;1===Number(s)?Storage$1.setLocal("EAPOP"+e.id+getToday(),0):Storage$1.setLocal("EAPOP"+e.id,0)}}const ansModal=AnsModal.getInstance();wx.AnalysysModal=e=>{wx.AnalysysAgentModalConfig&&wx.AnalysysAgentModalConfig.appKey&&wx.AnalysysAgentModalConfig.configURL?ansModal.init(e,Event$1.pageKey):console.warn("EA -- 请设置弹窗配置appKey和configURL")},Component({data:{visible:!1,popupData:{},cacheData:[],currentPage:null},attached(){let e=getCurrentPages();this.currentPage=e[e.length-1].route,Event$1.on("setVisible"+this.currentPage,e=>{if(this.data.visible){let t=!1;for(let a=0;a<this.data.cacheData.length;a++)if(this.data.cacheData[a].id===e.id){t=!0;break}e.id===this.data.popupData.id&&(t=!0),t||this.data.cacheData.unshift(e)}else this.dealData(e)})},detached(){this.hideModal()},methods:{dealData(e){this.setData({popupData:e,visible:!0}),ansModal.upLoadEvent("$impDialog",{$dialog_id:e.id,$dialog_type:1})},hideModal(){this.setData({visible:!1});let e=Storage$1.getLocal(ansModal.token+ansModal.userId+getToday());if(-99999!==e&&e<=0)return;let t=this.data.cacheData.length;t>0&&(this.dealData(this.data.cacheData[t-1]),this.data.cacheData.pop())},handleClick(e,t,a){let i=this.data.popupData;if(!i.id)return void this.hideModal();ansModal.upLoadEvent(t,{$dialog_id:i.id.toString(),$dialog_type:a}),ansModal.dealModalPopNum(i),this.hideModal();let s="";e&&("/"!==e.charAt(0)&&(s="/"+e),wx.redirectTo({url:s}),wx.switchTab({url:s}))},handleClose(){this.handleClick("","$closeDialog",3)},handleLeftClick(){this.handleClick(this.data.popupData&&this.data.popupData.buttonLeft.clickEvent,"$clickDialog",4)},handleRightClick(){this.handleClick(this.data.popupData&&this.data.popupData.buttonRight.clickEvent,"$clickDialog",5)},handleMiddleClick(){this.handleClick(this.data.popupData&&this.data.popupData.buttonMiddle.clickEvent,"$clickDialog",6)},onImageClick(e){if(0===e.currentTarget.dataset.type){let e=this.data.popupData&&this.data.popupData.clickEvent;this.handleClick(e,"$clickDialog",2)}else ansModal.upLoadEvent("$clickDialog",{$dialog_id:this.data.popupData.id.toString(),$dialog_type:2})},onImageError(){this.hideModal()}}});